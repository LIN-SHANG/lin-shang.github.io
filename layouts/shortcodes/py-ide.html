<!-- 
  PyScript IDE (V7.3 - Scoped & Forced Styles)
  ‰øÆÂ§çÔºö‰ΩøÁî® scoped CSS + !important Âº∫Âà∂Ë¶ÜÁõñ Hugo ‰∏ªÈ¢òËá™Â∏¶ÁöÑ Prism Ê†∑Âºè
-->

<style>
  /* === Py-IDE ÂÆπÂô® === */
  .py-ide-container { 
    display: flex; 
    flex-wrap: wrap; 
    margin: 2rem 0; 
    
    /* ÈªòËÆ§ÊµÖËâ≤ÂèòÈáè */
    background-color: var(--ide-bg); 
    color: var(--ide-fg);
    border: 1px solid var(--ide-border); 
    
    border-radius: 8px; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden; 
    font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
    transition: background-color 0.3s, border-color 0.3s;
  }

  .py-main-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; border-right: 1px solid var(--ide-border); }
  .py-sidebar-col { width: 260px; background: var(--ide-header-bg); display: flex; flex-direction: column; font-size: 13px; border-left: 1px solid var(--ide-border); }
  
  .py-header { 
    background: var(--ide-header-bg);
    padding: 0 12px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-bottom: 1px solid var(--ide-border); 
    height: 38px; 
    font-size: 12px; 
    font-weight: 600; 
    color: var(--ide-header-text); 
    user-select: none;
  }
  
  .py-header-title { display: flex; align-items: center; gap: 10px; }
  .py-shortcut-hint { font-size: 10px; opacity: 0.7; border: 1px solid var(--ide-border); padding: 1px 5px; border-radius: 4px; }
  .py-btn-group { display: flex; gap: 8px; }

  /* === ÁºñËæëÂô®Ê†∑Âºè === */
  .py-editor { 
    min-height: 250px; 
    padding: 15px; 
    font-family: var(--code-font-stack, monospace);
    font-size: 14px !important; 
    line-height: 1.6 !important; 
    
    /* ÈªòËÆ§ÊµÖËâ≤ */
    background-color: var(--ide-bg); 
    color: var(--ide-fg);
    
    outline: none; 
    overflow: auto; 
    caret-color: var(--ide-cursor); 
    white-space: pre !important;
  }
  
  /* ÁßªÈô§ÁºñËæëÂô®ÂÜÖÈÉ®Âπ≤Êâ∞Ê†∑Âºè */
  .py-editor pre[class*="language-"], 
  .py-editor code[class*="language-"] {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    margin: 0 !important;
    padding: 0 !important;
    color: inherit !important;
    text-shadow: none !important;
  }

  /* === ËæìÂá∫Âå∫Âüü === */
  .py-output { 
    background: var(--ide-output-bg); 
    color: var(--ide-fg); 
    padding: 10px 15px; 
    font-family: var(--code-font-stack, monospace);
    font-size: 13px; 
    white-space: pre-wrap; 
    border-top: 1px solid var(--ide-border); 
    max-height: 250px; 
    overflow-y: auto; 
    border-left: 4px solid var(--ide-output-border); 
  }
  
  /* ÊªöÂä®Êù° */
  .py-editor::-webkit-scrollbar, .py-output::-webkit-scrollbar { width: 10px; height: 10px; }
  .py-editor::-webkit-scrollbar-track, .py-output::-webkit-scrollbar-track { background: transparent; }
  .py-editor::-webkit-scrollbar-thumb, .py-output::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }

  /* ÊåâÈíÆÈÄÇÈÖç */
  .py-icon-btn { border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; transition: 0.2s; }
  .py-run-btn { background: #2e7d32; color: #fff; }
  .py-run-btn:hover { background: #4caf50; }
  .py-run-btn:disabled { background: #444; color: #888; cursor: not-allowed; }
  .py-reset-btn { background: transparent; color: var(--ide-header-text); border: 1px solid var(--ide-border); }
  .py-reset-btn:hover { background: rgba(128,128,128,0.2); }

  /* ÂèòÈáèÊ†ë */
  .py-tree-container { flex: 1; overflow-y: auto; padding: 10px; font-family: var(--code-font-stack, monospace); }
  .t-node { margin-left: 14px; line-height: 1.6; }
  .t-key { color: var(--token-variable); margin-right: 5px; cursor: pointer; }
  .t-key:hover { text-decoration: underline; opacity: 0.8; }
  .t-val { color: var(--token-string); }
  .t-type { color: var(--token-class); opacity: 0.7; font-size: 0.85em; margin-left: 6px; font-style: italic;}
  .t-arrow { display: inline-block; width: 14px; color: var(--ide-header-text); cursor: pointer; transition: transform 0.1s; font-size: 10px; text-align: center;}
  .t-arrow.open { transform: rotate(90deg); }
  .t-collapsible { display: none; border-left: 1px solid var(--ide-border); margin-left: 4px; padding-left: 4px; }
  .t-collapsible.open { display: block; }
  .t-empty { color: var(--ide-header-text); font-style: italic; margin-left: 14px; opacity: 0.6;}
  
  .py-plot-container { background: #fff; padding: 15px; text-align: center; border-top: 1px solid var(--ide-border); display: none; }
</style>

{{ $rawContent := .Inner }}
{{ $cleanContent := $rawContent | replaceRE "^(?s)\\s*```[a-zA-Z0-9]*\\s+" "" }}
{{ $cleanContent := $cleanContent | replaceRE "\\s*```\\s*$" "" }}
{{ $b64Code := $cleanContent | base64Encode }}

<div class="py-ide-container">
    <div class="py-main-col">
        <div class="py-header">
            <div class="py-header-title">
                <span>TERMINAL</span>
                <span class="py-shortcut-hint">Ctrl + Enter to Run</span>
            </div>
            <div class="py-btn-group">
                <button id="reset-{{ .Ordinal }}" class="py-icon-btn py-reset-btn" py-click="reset_code_{{ .Ordinal }}">‚Ü∫ RESET</button>
                <button id="btn-{{ .Ordinal }}" class="py-icon-btn py-run-btn" py-click="run_code_{{ .Ordinal }}">‚ñ∂ RUN</button>
            </div>
        </div>
        
        <div id="editor-{{ .Ordinal }}" class="py-editor language-python" data-code="{{ $b64Code }}"></div>
        <div class="py-output" id="output-{{ .Ordinal }}">> Initializing Python...</div>
        
        <div id="plot-header-{{ .Ordinal }}" class="py-header" style="display: none; justify-content: flex-end; border-top: 1px solid #333;">
            <button id="copy-png-btn-{{ .Ordinal }}" class="py-icon-btn py-reset-btn">Â§çÂà∂‰∏∫ PNG</button>
        </div>
        <div class="py-plot-container" id="plot-{{ .Ordinal }}"></div>
    </div>

    <div class="py-sidebar-col">
        <div class="py-header">VARIABLES</div>
        <div id="tree-{{ .Ordinal }}" class="py-tree-container"></div>
    </div>
</div>

<script type="module">
    import { CodeJar } from 'https://cdn.jsdelivr.net/npm/codejar@3.7.0/codejar.min.js';

    document.addEventListener("DOMContentLoaded", () => {
        const editorEl = document.getElementById("editor-{{ .Ordinal }}");
        const copyBtn = document.getElementById("copy-png-btn-{{ .Ordinal }}");

        if (!editorEl) return;

        // --- 1. È´ò‰∫ÆÂáΩÊï∞ ---
        // Á°Æ‰øù‰ΩøÁî® custom_style.html ÈáåÂä†ËΩΩÁöÑ Prism
        const highlight = (editor) => {
            if (window.Prism) {
                editor.innerHTML = Prism.highlight(
                    editor.textContent, 
                    Prism.languages.python, 
                    'python'
                );
            }
        };

        // --- 2. CodeJar ÂàùÂßãÂåñ ---
        const jar = CodeJar(editorEl, highlight, { tab: '    ' });

        // --- 3. MutationObserver ‰∏ªÈ¢òÁõëÂê¨ (‰øùÈô©Ëµ∑ËßÅ) ---
        // ÁõëÂê¨ html Ê†áÁ≠æ class ÂèòÂåñÔºåÂº∫Âà∂ CodeJar ÈáçÁªò‰ª•Â∫îÁî®Êñ∞ÁöÑ CSS ÂèòÈáè
        const observer = new MutationObserver((mutations) => {
            for(let mutation of mutations) {
                if (mutation.type === "attributes" && (mutation.attributeName === "class" || mutation.attributeName === "data-theme")) {
                    // ÈáçÊñ∞Â∫îÁî®‰ª£Á†Å‰ª•Ëß¶ÂèëÈ´ò‰∫ÆÈáçÁªòÔºåÁ°Æ‰øùÈ¢úËâ≤ÂèòÈáèÁîüÊïà
                    const code = jar.toString();
                    requestAnimationFrame(() => {
                        // Âº∫Âà∂Ëß¶Âèë‰∏ÄÊ¨°ÈáçÁªòÔºåÊúâ‰∫õÊµèËßàÂô®ÂàáÊç¢ÂèòÈáè‰ºöÊúâÂª∂Ëøü
                        editorEl.style.display = 'none';
                        editorEl.offsetHeight; // trigger reflow
                        editorEl.style.display = 'block';
                    });
                }
            }
        });
        observer.observe(document.documentElement, { attributes: true });

        // --- 4. Â°´ÂÖÖÂàùÂßã‰ª£Á†Å ---
        try {
            const rawB64 = editorEl.getAttribute("data-code");
            const decodedCode = decodeURIComponent(escape(window.atob(rawB64)));
            jar.updateCode(decodedCode);
        } catch (e) {
            console.error("Decode error", e);
        }

        // --- Âø´Êç∑ÈîÆ ---
        editorEl.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') e.preventDefault();
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const runBtn = document.getElementById("btn-{{ .Ordinal }}");
                if (runBtn && !runBtn.disabled) runBtn.click();
            }
        });

        // --- ÂèòÈáèÊ†ëÊ∏≤Êüì (‰øùÊåÅÈÄªËæë‰∏çÂèò) ---
        window.renderJsonTree = (containerId, jsonString) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            let data;
            try { data = JSON.parse(jsonString); } catch (e) { return; }
            const createNode = (key, value, type, children) => {
                const div = document.createElement("div");
                div.className = "t-node";
                if (children !== null) {
                    const arrow = document.createElement("span");
                    arrow.className = "t-arrow";
                    arrow.innerText = "‚ñ∂";
                    const label = document.createElement("span");
                    label.innerHTML = `<span class="t-key">${key}:</span><span class="t-type">${type}</span>`;
                    const childContainer = document.createElement("div");
                    childContainer.className = "t-collapsible";
                    const toggle = (e) => {
                        e.stopPropagation();
                        childContainer.classList.toggle("open");
                        arrow.classList.toggle("open");
                        arrow.innerText = arrow.classList.contains("open") ? "‚ñº" : "‚ñ∂";
                    };
                    arrow.onclick = toggle;
                    label.onclick = toggle;
                    div.appendChild(arrow);
                    div.appendChild(label);
                    div.appendChild(childContainer);
                    if (Object.keys(children).length === 0) {
                        childContainer.innerHTML = '<div class="t-empty">(empty)</div>';
                    } else {
                        for (const [k, v] of Object.entries(children)) {
                            childContainer.appendChild(createNode(k, v.val, v.type, v.children));
                        }
                    }
                } else {
                    div.innerHTML = `<span class="t-key" style="cursor:default">${key}:</span><span class="t-val">${value}</span>`;
                }
                return div;
            };
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div class="t-empty" style="margin-top:10px">No user variables</div>';
            } else {
                for (const [k, v] of Object.entries(data)) {
                    container.appendChild(createNode(k, v.val, v.type, v.children));
                }
            }
        };

        // --- Êà™ÂõæÂäüËÉΩ ---
        const copyPlotAsPng = (btn) => {
             const plotContainer = document.getElementById("plot-{{ .Ordinal }}");
             const svgElement = plotContainer ? plotContainer.querySelector('svg') : null;
             if (!svgElement) { alert("Êâæ‰∏çÂà∞ÂõæÂÉè„ÄÇ"); return; }
             const canvas = document.createElement('canvas');
             const ctx = canvas.getContext('2d');
             const scale = 2; 
             const viewbox = svgElement.viewBox.baseVal;
             canvas.width = viewbox.width * scale;
             canvas.height = viewbox.height * scale;
             const img = new Image();
             const svgData = new XMLSerializer().serializeToString(svgElement);
             const svgUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
             img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                        .then(() => {
                            const originalText = btn.innerText;
                            btn.innerText = "Â∑≤Â§çÂà∂!";
                            setTimeout(() => { btn.innerText = originalText; }, 2000);
                        })
                        .catch(err => { console.error('Â§çÂà∂Â§±Ë¥•', err); alert('Â§çÂà∂Â§±Ë¥•'); });
                }, 'image/png');
             };
             img.src = svgUrl;
        };
        if (copyBtn) copyBtn.onclick = (e) => copyPlotAsPng(e.target);
    });
</script>

<!-- 
  Python ÊâßË°åÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèò 
  (‰∏∫‰∫ÜËäÇÁúÅÁØáÂπÖÔºåËØ∑‰øùÁïô‰Ω†ÂéüÊñá‰ª∂‰∏≠ <script type="py">...</script> ÁöÑÊâÄÊúâÂÜÖÂÆπ)
-->
<script type="py" config='{"packages": ["micropip"]}'>
    from pyscript import window, document, HTML
    import sys, io, micropip, asyncio, html, types, json, base64, os

    class DOMStream:
        def __init__(self, element_id): self.element_id = element_id
        def write(self, text):
            el = document.getElementById(self.element_id)
            if el:
                el.innerText += text
                el.scrollTop = el.scrollHeight
        def flush(self): pass

    if 'kernels' not in globals(): kernels = {}
    if {{ .Ordinal }} not in kernels: kernels[{{ .Ordinal }}] = {}

    async def init_system_{{ .Ordinal }}():
        output_id = "output-{{ .Ordinal }}"
        stream = DOMStream(output_id)
        stream.write("> Core loaded.\n")
        stream.write("> Downloading libraries & resources...\n")
        
        try:
            await micropip.install(["numpy", "matplotlib"])
            import matplotlib
            matplotlib.use("Agg") 
            import matplotlib.pyplot as plt
            import matplotlib.font_manager as fm
            from pyodide.http import pyfetch

            font_url = "{{ "font/LXGWWenKaiLite-Light.ttf" | relURL }}" 
            font_path = "LXGWWenKaiLite-Light.ttf" 
            stream.write(f"> Fetching font from: {font_url}\n")
            
            response = await pyfetch(font_url)
            if response.status == 200:
                with open(font_path, "wb") as f:
                    f.write(await response.bytes())
                fm.fontManager.addfont(font_path)
                plt.rcParams['font.family'] = ['LXGW WenKai Lite'] 
                plt.rcParams['axes.unicode_minus'] = False 
                stream.write("> Chinese font configured.\n")
            else:
                stream.write(f"> Warning: Failed to fetch font (Status {response.status}).\n")
            stream.write("> System Ready. üöÄ\n")
        except Exception as e:
            stream.write(f"> Init Error: {e}\n")

    asyncio.ensure_future(init_system_{{ .Ordinal }}())

    def get_scope_tree(scope):
        tree_data = {}
        def safe_str(v):
            try: s = str(v)
            except: s = "<error>"
            return html.escape(s[:50] + "..." if len(s) > 50 else s)
        for k, v in scope.items():
            if k.startswith("_") or k in ['open', 'exit', 'quit', 'In', 'Out', 'get_ipython', 'show_plot', 'matplotlib', 'plt', 'micropip', 'fm', 'pyfetch', 'os']: continue
            if isinstance(v, (types.ModuleType, types.FunctionType, type)): continue
            val_type = type(v).__name__
            children = None
            display_val = safe_str(v)
            if isinstance(v, dict):
                children = {}
                display_val = f"dict[{len(v)}]"
                for sk, sv in list(v.items())[:20]:
                    children[str(sk)] = {"val": safe_str(sv), "type": type(sv).__name__, "children": None}
            elif isinstance(v, (list, tuple)):
                children = {}
                display_val = f"{val_type}[{len(v)}]"
                for i, sv in enumerate(v[:20]):
                    children[str(i)] = {"val": safe_str(sv), "type": type(sv).__name__, "children": None}
            tree_data[k] = {"val": display_val, "type": val_type, "children": children}
        return json.dumps(tree_data)

    def _show_plot_helper():
        try:
            import matplotlib.pyplot as plt
        except ImportError:
            print("Matplotlib not ready yet.")
            return
        plot_div = document.getElementById("plot-{{ .Ordinal }}")
        plot_header = document.getElementById("plot-header-{{ .Ordinal }}")
        buf = io.StringIO()
        try:
            plt.savefig(buf, format='svg', bbox_inches='tight')
            buf.seek(0)
            svg_string = buf.getvalue()
            plot_div.innerHTML = svg_string
            plot_div.style.display = "block"
            plot_header.style.display = "flex"
            print("System: SVG Plot generated.")
        except Exception as e:
            print(f"System Error: Plotting failed - {e}")
        finally:
            plt.clf()
            buf.close()

    def reset_code_{{ .Ordinal }}(event):
        kernels[{{ .Ordinal }}] = {}
        kernels[{{ .Ordinal }}]["show_plot"] = _show_plot_helper
        document.getElementById("output-{{ .Ordinal }}").innerText = "> Environment reset."
        window.renderJsonTree("tree-{{ .Ordinal }}", "{}")
        document.getElementById("plot-{{ .Ordinal }}").style.display = "none"
        document.getElementById("plot-header-{{ .Ordinal }}").style.display = "none"

    async def run_code_{{ .Ordinal }}(event):
        output_id = "output-{{ .Ordinal }}"
        tree_id = "tree-{{ .Ordinal }}"
        btn = document.getElementById("btn-{{ .Ordinal }}")
        output_el = document.getElementById(output_id)
        btn.disabled = True
        btn.innerText = "Running..."
        output_el.innerText = "" 
        user_selection = window.getSelection().toString()
        full_code = document.getElementById("editor-{{ .Ordinal }}").textContent
        code_to_run = user_selection if user_selection.strip() else full_code
        if user_selection.strip(): output_el.innerText = "> Running selection...\n"
        current_scope = kernels[{{ .Ordinal }}]
        if "show_plot" not in current_scope: current_scope["show_plot"] = _show_plot_helper
        first_line = code_to_run.strip().split('\n')[0]
        if first_line.startswith("# install:"):
            pkgs = [p.strip() for p in first_line.replace("# install:", "").split(",") if p.strip()]
            if pkgs:
                output_el.innerText += f"> Installing: {', '.join(pkgs)}...\n"
                try: await micropip.install(pkgs)
                except Exception as e: output_el.innerText += f"Install failed: {e}\n"
        stream = DOMStream(output_id)
        original_stdout, original_stderr = sys.stdout, sys.stderr
        sys.stdout, sys.stderr = stream, stream
        try:
            exec(code_to_run, current_scope, current_scope)
        except Exception as e:
            print(f"Runtime Error: {e}")
        finally:
            sys.stdout, sys.stderr = original_stdout, original_stderr
            try:
                tree_json = get_scope_tree(current_scope)
                window.renderJsonTree(tree_id, tree_json)
            except Exception as e: print(f"Tree Error: {e}")
            btn.disabled = False
            btn.innerText = "‚ñ∂ RUN"
</script>