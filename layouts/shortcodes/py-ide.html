<!-- Py-IDE: 统一字体版 -->
<style>
  /* 1. 继承全局变量 */
  .py-ide-wrapper {
    /* 引用 custom_style.html 定义的全局字体 */
    --ide-font: var(--global-code-font);
    --ide-size: var(--global-code-size);
    --ide-lh: var(--global-line-height);

    /* 按钮颜色 */
    --ide-btn-run: #2da44e;
    --ide-btn-text: #ffffff;
    --ide-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  /* 深色模式适配 */
  :root[data-theme="dark"] .py-ide-wrapper,
  html.dark .py-ide-wrapper, 
  body.dark .py-ide-wrapper {
    --ide-btn-run: #A9DC76;
    --ide-btn-text: #000000;
    --ide-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }

  /* 2. 容器样式 */
  .py-ide-container {
    background-color: var(--ide-bg); /* 来自全局变量 */
    color: var(--ide-fg);
    border: 1px solid var(--ide-border);
    border-radius: 8px;
    margin: 2rem 0;
    overflow: hidden;
    display: flex; flex-wrap: wrap; width: 100%;
    box-shadow: var(--ide-shadow);
    transition: all 0.3s ease;
  }

  .py-header { 
    height: 40px; padding: 0 12px; display: flex; justify-content: space-between; align-items: center; 
    background-color: var(--ide-header-bg); border-bottom: 1px solid var(--ide-border); 
    font-family: -apple-system, sans-serif; font-size: 12px; font-weight: 600; color: var(--ide-fg);
  }

  /* 3. 编辑器 & 输出: 强制使用全局字体 */
  .py-editor { 
    min-height: 200px; padding: 15px; 
    font-family: var(--ide-font) !important; 
    font-size: var(--ide-size) !important;
    line-height: var(--ide-lh) !important;
    background-color: transparent; color: inherit; outline: none; white-space: pre; overflow: auto;
  }
  
  .py-output { 
    padding: 10px 15px; border-top: 1px solid var(--ide-border); 
    background-color: rgba(127,127,127,0.05); color: var(--ide-fg);
    font-family: var(--ide-font) !important; 
    font-size: 13px; /* 输出区保持略小 */
    white-space: pre-wrap; max-height: 250px; overflow-y: auto;
  }

  /* 按钮样式 */
  .py-main-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; border-right: 1px solid var(--ide-border); }
  .py-sidebar-col { width: 260px; border-left: 1px solid var(--ide-border); display: flex; flex-direction: column; font-size: 13px;}
  .py-btn-group { display: flex; gap: 8px; align-items: center; }
  .py-run-btn { 
    background: var(--ide-btn-run) !important; color: var(--ide-btn-text) !important; 
    border: none; padding: 5px 16px; border-radius: 4px; cursor: pointer; 
    font-weight: 800; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    transition: transform 0.1s;
  }
  .py-run-btn:active { transform: translateY(1px); }
  .py-icon-btn { 
    background: transparent; color: var(--ide-fg); border: 1px solid var(--ide-border); 
    padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; 
  }
  .py-tree-container { padding: 10px; flex: 1; overflow-y: auto; }
  .py-plot-container { background: white; padding: 15px; text-align: center; border-top: 1px solid var(--ide-border); display: none; }
</style>

{{ $rawContent := .Inner }}
{{ $cleanContent := $rawContent | replaceRE "^(?s)\\s*```[a-zA-Z0-9]*\\s+" "" }}
{{ $cleanContent := $cleanContent | replaceRE "\\s*```\\s*$" "" }}
{{ $b64Code := $cleanContent | base64Encode }}

<div class="py-ide-wrapper">
    <div class="py-ide-container">
        <div class="py-main-col">
            <div class="py-header">
                <span>TERMINAL</span>
                <div class="py-btn-group">
                    <button id="copy-code-{{ .Ordinal }}" class="py-icon-btn" onclick="copyIdeCode('{{ .Ordinal }}')">COPY</button>
                    <button class="py-icon-btn" py-click="reset_code_{{ .Ordinal }}">RESET</button>
                    <button id="btn-{{ .Ordinal }}" class="py-run-btn" py-click="run_code_{{ .Ordinal }}">▶ RUN</button>
                </div>
            </div>
            
            <div id="editor-{{ .Ordinal }}" class="py-editor language-python" data-code="{{ $b64Code }}"></div>
            <div class="py-output" id="output-{{ .Ordinal }}">> Ready.</div>
            
            <div id="plot-header-{{ .Ordinal }}" class="py-header" style="display: none; justify-content: flex-end; border-top: 1px solid var(--ide-border);">
                <button id="copy-png-btn-{{ .Ordinal }}" class="py-icon-btn">Save PNG</button>
            </div>
            <div class="py-plot-container" id="plot-{{ .Ordinal }}"></div>
        </div>

        <div class="py-sidebar-col">
            <div class="py-header">VARIABLES</div>
            <div id="tree-{{ .Ordinal }}" class="py-tree-container"></div>
        </div>
    </div>
</div>

<script type="module">
    import { CodeJar } from 'https://cdn.jsdelivr.net/npm/codejar@3.7.0/codejar.min.js';

    window.copyIdeCode = function(ordinal) {
        const el = document.getElementById(`editor-${ordinal}`);
        if(el) {
            navigator.clipboard.writeText(el.innerText).then(() => {
                const btn = document.getElementById(`copy-code-${ordinal}`);
                const old = btn.innerText;
                btn.innerText = "✓";
                setTimeout(() => { btn.innerText = old; }, 1500);
            });
        }
    };

    document.addEventListener("DOMContentLoaded", () => {
        const editorEl = document.getElementById("editor-{{ .Ordinal }}");
        if (!editorEl) return;

        const highlight = (editor) => {
            if (window.Prism && Prism.languages.python) {
                editor.innerHTML = Prism.highlight(editor.textContent, Prism.languages.python, 'python');
            }
        };

        const jar = CodeJar(editorEl, highlight, { tab: '    ' });

        try {
            const raw = editorEl.getAttribute("data-code");
            const decoded = decodeURIComponent(escape(window.atob(raw)));
            jar.updateCode(decoded);
        } catch (e) { console.error(e); }

        editorEl.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById("btn-{{ .Ordinal }}").click();
            }
        });

        // Plot Copy
        const copyBtn = document.getElementById("copy-png-btn-{{ .Ordinal }}");
        if(copyBtn) {
            copyBtn.onclick = () => {
                const plot = document.getElementById("plot-{{ .Ordinal }}");
                const svg = plot.querySelector('svg');
                if(!svg) return;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                const data = (new XMLSerializer()).serializeToString(svg);
                img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(data);
                img.onload = () => {
                    canvas.width = svg.viewBox.baseVal.width * 2;
                    canvas.height = svg.viewBox.baseVal.height * 2;
                    ctx.fillStyle = 'white'; ctx.fillRect(0,0,canvas.width,canvas.height);
                    ctx.drawImage(img, 0,0,canvas.width,canvas.height);
                    canvas.toBlob(b => navigator.clipboard.write([new ClipboardItem({'image/png':b})]));
                    const old = copyBtn.innerText;
                    copyBtn.innerText = "Copied!";
                    setTimeout(() => copyBtn.innerText = old, 1500);
                };
            };
        }
    });
</script>

<script type="py" config='{"packages": ["micropip", "numpy", "matplotlib"]}'>
    from pyscript import window, document
    import sys, io, micropip, asyncio, html, json

    if 'kernels' not in globals(): kernels = {}
    kernels[{{ .Ordinal }}] = {}

    class DOMStream:
        def __init__(self, element_id): self.id = element_id
        def write(self, text):
            el = document.getElementById(self.id)
            if el: el.innerText += text; el.scrollTop = el.scrollHeight
        def flush(self): pass

    def get_scope_tree(scope):
        data = {}
        for k, v in scope.items():
            if k.startswith("_") or hasattr(v, '__call__') or type(v).__name__ == 'module': continue
            val_str = str(v)[:50]
            data[k] = {"val": html.escape(val_str), "type": type(v).__name__}
        return json.dumps(data)

    def _show_plot():
        import matplotlib.pyplot as plt
        div = document.getElementById("plot-{{ .Ordinal }}")
        hdr = document.getElementById("plot-header-{{ .Ordinal }}")
        buf = io.StringIO()
        plt.savefig(buf, format='svg', bbox_inches='tight')
        div.innerHTML = buf.getvalue()
        div.style.display = "block"
        hdr.style.display = "flex"
        plt.clf()

    def reset_code_{{ .Ordinal }}(e):
        kernels[{{ .Ordinal }}] = {"show_plot": _show_plot}
        document.getElementById("output-{{ .Ordinal }}").innerText = "> Reset.\n"
        window.renderJsonTree("tree-{{ .Ordinal }}", "{}")
        document.getElementById("plot-{{ .Ordinal }}").style.display = "none"
        document.getElementById("plot-header-{{ .Ordinal }}").style.display = "none"

    async def run_code_{{ .Ordinal }}(e):
        btn = document.getElementById("btn-{{ .Ordinal }}")
        out = document.getElementById("output-{{ .Ordinal }}")
        editor = document.getElementById("editor-{{ .Ordinal }}")
        btn.disabled = True
        btn.innerText = "Running..."
        out.innerText = ""
        
        code = window.getSelection().toString()
        if not code.strip(): code = editor.textContent
        
        scope = kernels[{{ .Ordinal }}]
        if "show_plot" not in scope: scope["show_plot"] = _show_plot
        
        stream = DOMStream("output-{{ .Ordinal }}")
        sys.stdout = stream
        sys.stderr = stream
        
        try:
            await asyncio.sleep(0.1)
            exec(code, scope, scope)
        except Exception as err:
            print(f"Error: {err}")
        finally:
            sys.stdout = sys.__stdout__
            try:
                tree = get_scope_tree(scope)
                window.renderJsonTree("tree-{{ .Ordinal }}", tree)
            except: pass
            btn.disabled = False
            btn.innerText = "▶ RUN"
</script>