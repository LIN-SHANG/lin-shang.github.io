<!-- 
  PyScript IDE (Monokai Pro Ultimate)
  å®Œå…¨ä¾èµ– custom_style.html å®šä¹‰çš„ CSS å˜é‡ï¼Œç¡®ä¿ä¸å›¾ç‰‡ä¸€è‡´
-->

<style>
  /* === IDE å®¹å™¨æ ·å¼ === */
  .py-ide-container {
    background-color: var(--mk-bg) !important; /* æ ¸å¿ƒï¼šä½¿ç”¨ Monokai Pro èƒŒæ™¯ */
    color: var(--mk-fg) !important;
    border: 1px solid var(--mk-border);
    border-radius: 8px;
    margin: 2rem 0;
    overflow: hidden;
    display: flex; 
    flex-wrap: wrap; 
    box-shadow: 0 8px 24px rgba(0,0,0,0.12); /* æ›´æŸ”å’Œçš„æŠ•å½± */
    transition: background-color 0.3s, border-color 0.3s;
  }

  /* å¤´éƒ¨å’Œä¾§è¾¹æ ç¨å¾®å˜è‰²ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
  .py-sidebar-col, .py-header {
    background-color: rgba(128,128,128, 0.05) !important; /* å åŠ ä¸€å±‚æ·¡æ·¡çš„é®ç½© */
    border-color: var(--mk-border) !important;
  }

  /* === ç¼–è¾‘å™¨åŒºåŸŸ === */
  .py-main-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; border-right: 1px solid var(--mk-border); }
  .py-sidebar-col { width: 260px; border-left: 1px solid var(--mk-border); font-size: 13px; display: flex; flex-direction: column; }
  
  .py-header { 
    height: 38px; padding: 0 12px; display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 1px solid var(--mk-border); 
    font-size: 12px; font-weight: 600; color: var(--mk-fg); opacity: 0.9;
  }

  /* ç¼–è¾‘å™¨æœ¬ä½“ - å…³é”®ï¼èƒŒæ™¯é€æ˜ï¼Œæ–‡å­—ç»§æ‰¿ */
  .py-editor { 
    min-height: 250px; 
    padding: 15px; 
    font-family: var(--code-font-stack, monospace) !important;
    font-size: 14px !important; 
    line-height: 1.6 !important; 
    background-color: transparent !important; /* å…³é”® */
    color: inherit !important;                /* å…³é”® */
    outline: none; 
    overflow: auto; 
    caret-color: var(--mk-keyword);           /* å…‰æ ‡è·Ÿéšå…³é”®å­—é¢œè‰²(ç²‰çº¢) */
    white-space: pre !important;
  }

  /* è¾“å‡ºåŒºåŸŸ */
  .py-output { 
    padding: 10px 15px; font-family: monospace; font-size: 13px; white-space: pre-wrap; 
    border-top: 1px solid var(--mk-border); 
    max-height: 250px; overflow-y: auto; 
    background-color: rgba(0,0,0,0.02) !important; /* è¾“å‡ºåŒºææ·¡çš„èƒŒæ™¯åŒºåˆ† */
    color: var(--mk-fg);
  }
  
  /* æ»šåŠ¨æ¡ç¾åŒ– */
  .py-editor::-webkit-scrollbar, .py-output::-webkit-scrollbar, .py-tree-container::-webkit-scrollbar { width: 8px; height: 8px; }
  .py-editor::-webkit-scrollbar-track, .py-output::-webkit-scrollbar-track { background: transparent; }
  .py-editor::-webkit-scrollbar-thumb, .py-output::-webkit-scrollbar-thumb { background: var(--mk-border); border-radius: 4px; }
  .py-editor::-webkit-scrollbar-thumb:hover { background: var(--mk-fg); opacity: 0.5; }

  /* æŒ‰é’® - æ¨¡ä»¿ Pro é£æ ¼ */
  .py-run-btn { 
    background: var(--mk-function); /* ç»¿è‰²æŒ‰é’® */
    color: #2D2A2E;                 /* é»‘è‰²æ–‡å­— */
    border: none; padding: 4px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px;
    transition: filter 0.2s;
  }
  .py-run-btn:hover { filter: brightness(1.1); }
  .py-run-btn:disabled { background: var(--mk-border); color: var(--mk-fg); cursor: not-allowed; filter: none; opacity: 0.6; }
  
  .py-reset-btn { 
    background: transparent; color: var(--mk-fg); border: 1px solid var(--mk-border); 
    padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;
  }
  .py-reset-btn:hover { border-color: var(--mk-keyword); color: var(--mk-keyword); }

  /* å˜é‡æ ‘ */
  .py-tree-container { padding: 10px; flex: 1; overflow-y: auto; }
  .t-node { margin-left: 14px; line-height: 1.6; }
  .t-key { color: var(--mk-class); cursor: pointer; }   /* è“è‰² Key */
  .t-val { color: var(--mk-string); }                   /* é»„è‰² Value */
  .t-type { color: var(--mk-comment); font-size: 0.85em; margin-left: 5px; font-style: italic;}
  .t-arrow { display: inline-block; width: 14px; color: var(--mk-fg); cursor: pointer; font-size: 10px; opacity: 0.7;}
  .t-collapsible { display: none; border-left: 1px solid var(--mk-border); margin-left: 4px; padding-left: 4px; }
  .t-collapsible.open { display: block; }
  .t-empty { color: var(--mk-comment); font-style: italic; opacity: 0.7; }
  
  .py-plot-container { background: white; padding: 15px; text-align: center; border-top: 1px solid var(--mk-border); display: none; }
</style>

{{ $rawContent := .Inner }}
{{ $cleanContent := $rawContent | replaceRE "^(?s)\\s*```[a-zA-Z0-9]*\\s+" "" }}
{{ $cleanContent := $cleanContent | replaceRE "\\s*```\\s*$" "" }}
{{ $b64Code := $cleanContent | base64Encode }}

<div class="py-ide-container">
    <div class="py-main-col">
        <div class="py-header">
            <div class="py-header-title">TERMINAL</div>
            <div class="py-btn-group">
                <button id="reset-{{ .Ordinal }}" class="py-reset-btn" py-click="reset_code_{{ .Ordinal }}">RESET</button>
                <button id="btn-{{ .Ordinal }}" class="py-run-btn" py-click="run_code_{{ .Ordinal }}">â–¶ RUN</button>
            </div>
        </div>
        
        <div id="editor-{{ .Ordinal }}" class="py-editor language-python" data-code="{{ $b64Code }}"></div>
        <div class="py-output" id="output-{{ .Ordinal }}">> Ready.</div>
        
        <div id="plot-header-{{ .Ordinal }}" class="py-header" style="display: none; justify-content: flex-end; border-top: 1px solid var(--mk-border);">
            <button id="copy-png-btn-{{ .Ordinal }}" class="py-reset-btn">Copy PNG</button>
        </div>
        <div class="py-plot-container" id="plot-{{ .Ordinal }}"></div>
    </div>

    <div class="py-sidebar-col">
        <div class="py-header">VARIABLES</div>
        <div id="tree-{{ .Ordinal }}" class="py-tree-container"></div>
    </div>
</div>

<script type="module">
    import { CodeJar } from 'https://cdn.jsdelivr.net/npm/codejar@3.7.0/codejar.min.js';

    document.addEventListener("DOMContentLoaded", () => {
        const editorEl = document.getElementById("editor-{{ .Ordinal }}");
        const copyBtn = document.getElementById("copy-png-btn-{{ .Ordinal }}");

        if (!editorEl) return;

        // é«˜äº®é€»è¾‘
        const highlight = (editor) => {
            // ç¡®ä¿ Prism å­˜åœ¨
            if (window.Prism) {
                // Prism ä¼šç”Ÿæˆ <span class="token keyword"> è¿™æ ·çš„æ ‡ç­¾
                // è¿™äº›æ ‡ç­¾ä¼šè‡ªåŠ¨åŒ¹é…æˆ‘ä»¬åœ¨ custom_style.html é‡Œå®šä¹‰çš„é¢œè‰²å˜é‡
                editor.innerHTML = Prism.highlight(
                    editor.textContent, 
                    Prism.languages.python, 
                    'python'
                );
            }
        };

        const jar = CodeJar(editorEl, highlight, { tab: '    ' });

        try {
            const rawB64 = editorEl.getAttribute("data-code");
            const decodedCode = decodeURIComponent(escape(window.atob(rawB64)));
            jar.updateCode(decodedCode);
        } catch (e) {
            console.error(e);
            editorEl.innerText = "# Error loading code";
        }

        editorEl.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const runBtn = document.getElementById("btn-{{ .Ordinal }}");
                if (runBtn && !runBtn.disabled) runBtn.click();
            }
        });

        const copyPlotAsPng = (btn) => {
             const plotContainer = document.getElementById("plot-{{ .Ordinal }}");
             const svgElement = plotContainer ? plotContainer.querySelector('svg') : null;
             if (!svgElement) { alert("No plot to copy"); return; }
             const canvas = document.createElement('canvas');
             const ctx = canvas.getContext('2d');
             const scale = 2; 
             const viewbox = svgElement.viewBox.baseVal;
             canvas.width = viewbox.width * scale;
             canvas.height = viewbox.height * scale;
             const img = new Image();
             const svgData = new XMLSerializer().serializeToString(svgElement);
             const svgUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
             img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                        .then(() => {
                            const originalText = btn.innerText;
                            btn.innerText = "Copied!";
                            setTimeout(() => { btn.innerText = originalText; }, 2000);
                        })
                        .catch(err => { console.error(err); alert('Failed to copy'); });
                }, 'image/png');
             };
             img.src = svgUrl;
        };
        if (copyBtn) copyBtn.onclick = (e) => copyPlotAsPng(e.target);
    });
</script>

<!-- Python æ‰§è¡Œéƒ¨åˆ†ä¿æŒåŸæ ·ï¼Œç›´æ¥ç²˜è´´ä½ ä¹‹å‰çš„ä»£ç å³å¯ -->
<script type="py" config='{"packages": ["micropip"]}'>
    from pyscript import window, document, HTML
    import sys, io, micropip, asyncio, html, types, json, base64, os

    class DOMStream:
        def __init__(self, element_id): self.element_id = element_id
        def write(self, text):
            el = document.getElementById(self.element_id)
            if el:
                el.innerText += text
                el.scrollTop = el.scrollHeight
        def flush(self): pass

    if 'kernels' not in globals(): kernels = {}
    if {{ .Ordinal }} not in kernels: kernels[{{ .Ordinal }}] = {}

    async def init_system_{{ .Ordinal }}():
        output_id = "output-{{ .Ordinal }}"
        stream = DOMStream(output_id)
        stream.write("> Core loaded.\n")
        stream.write("> Downloading libraries & resources...\n")
        
        try:
            await micropip.install(["numpy", "matplotlib"])
            import matplotlib
            matplotlib.use("Agg") 
            import matplotlib.pyplot as plt
            import matplotlib.font_manager as fm
            from pyodide.http import pyfetch

            font_url = "{{ "font/LXGWWenKaiLite-Light.ttf" | relURL }}" 
            font_path = "LXGWWenKaiLite-Light.ttf" 
            stream.write(f"> Fetching font from: {font_url}\n")
            
            response = await pyfetch(font_url)
            if response.status == 200:
                with open(font_path, "wb") as f:
                    f.write(await response.bytes())
                fm.fontManager.addfont(font_path)
                plt.rcParams['font.family'] = ['LXGW WenKai Lite'] 
                plt.rcParams['axes.unicode_minus'] = False 
                stream.write("> Chinese font configured.\n")
            else:
                stream.write(f"> Warning: Failed to fetch font (Status {response.status}).\n")
            stream.write("> System Ready. ğŸš€\n")
        except Exception as e:
            stream.write(f"> Init Error: {e}\n")

    asyncio.ensure_future(init_system_{{ .Ordinal }}())

    def get_scope_tree(scope):
        tree_data = {}
        def safe_str(v):
            try: s = str(v)
            except: s = "<error>"
            return html.escape(s[:50] + "..." if len(s) > 50 else s)
        for k, v in scope.items():
            if k.startswith("_") or k in ['open', 'exit', 'quit', 'In', 'Out', 'get_ipython', 'show_plot', 'matplotlib', 'plt', 'micropip', 'fm', 'pyfetch', 'os']: continue
            if isinstance(v, (types.ModuleType, types.FunctionType, type)): continue
            val_type = type(v).__name__
            children = None
            display_val = safe_str(v)
            if isinstance(v, dict):
                children = {}
                display_val = f"dict[{len(v)}]"
                for sk, sv in list(v.items())[:20]:
                    children[str(sk)] = {"val": safe_str(sv), "type": type(sv).__name__, "children": None}
            elif isinstance(v, (list, tuple)):
                children = {}
                display_val = f"{val_type}[{len(v)}]"
                for i, sv in enumerate(v[:20]):
                    children[str(i)] = {"val": safe_str(sv), "type": type(sv).__name__, "children": None}
            tree_data[k] = {"val": display_val, "type": val_type, "children": children}
        return json.dumps(tree_data)

    def _show_plot_helper():
        try:
            import matplotlib.pyplot as plt
        except ImportError:
            print("Matplotlib not ready yet.")
            return
        plot_div = document.getElementById("plot-{{ .Ordinal }}")
        plot_header = document.getElementById("plot-header-{{ .Ordinal }}")
        buf = io.StringIO()
        try:
            plt.savefig(buf, format='svg', bbox_inches='tight')
            buf.seek(0)
            svg_string = buf.getvalue()
            plot_div.innerHTML = svg_string
            plot_div.style.display = "block"
            plot_header.style.display = "flex"
            print("System: SVG Plot generated.")
        except Exception as e:
            print(f"System Error: Plotting failed - {e}")
        finally:
            plt.clf()
            buf.close()

    def reset_code_{{ .Ordinal }}(event):
        kernels[{{ .Ordinal }}] = {}
        kernels[{{ .Ordinal }}]["show_plot"] = _show_plot_helper
        document.getElementById("output-{{ .Ordinal }}").innerText = "> Environment reset."
        window.renderJsonTree("tree-{{ .Ordinal }}", "{}")
        document.getElementById("plot-{{ .Ordinal }}").style.display = "none"
        document.getElementById("plot-header-{{ .Ordinal }}").style.display = "none"

    async def run_code_{{ .Ordinal }}(event):
        output_id = "output-{{ .Ordinal }}"
        tree_id = "tree-{{ .Ordinal }}"
        btn = document.getElementById("btn-{{ .Ordinal }}")
        output_el = document.getElementById(output_id)
        btn.disabled = True
        btn.innerText = "Running..."
        output_el.innerText = "" 
        user_selection = window.getSelection().toString()
        full_code = document.getElementById("editor-{{ .Ordinal }}").textContent
        code_to_run = user_selection if user_selection.strip() else full_code
        if user_selection.strip(): output_el.innerText = "> Running selection...\n"
        current_scope = kernels[{{ .Ordinal }}]
        if "show_plot" not in current_scope: current_scope["show_plot"] = _show_plot_helper
        first_line = code_to_run.strip().split('\n')[0]
        if first_line.startswith("# install:"):
            pkgs = [p.strip() for p in first_line.replace("# install:", "").split(",") if p.strip()]
            if pkgs:
                output_el.innerText += f"> Installing: {', '.join(pkgs)}...\n"
                try: await micropip.install(pkgs)
                except Exception as e: output_el.innerText += f"Install failed: {e}\n"
        stream = DOMStream(output_id)
        original_stdout, original_stderr = sys.stdout, sys.stderr
        sys.stdout, sys.stderr = stream, stream
        try:
            exec(code_to_run, current_scope, current_scope)
        except Exception as e:
            print(f"Runtime Error: {e}")
        finally:
            sys.stdout, sys.stderr = original_stdout, original_stderr
            try:
                tree_json = get_scope_tree(current_scope)
                window.renderJsonTree(tree_id, tree_json)
            except Exception as e: print(f"Tree Error: {e}")
            btn.disabled = False
            btn.innerText = "â–¶ RUN"
</script>