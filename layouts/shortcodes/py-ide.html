<!-- 
  PyScript IDE (V7.1 - DOM-Ready Initialization)
  ä¿®å¤ï¼šè§£å†³å›  JS æ‰§è¡Œæ—¶æœºè¿‡æ—©å¯¼è‡´ IDE æ— æ³•åŠ è½½çš„è‡´å‘½é—®é¢˜ (Race Condition)
-->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-vsc-dark-plus.min.css" rel="stylesheet" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<style>
  /* === æ ·å¼ä¿æŒä¸å˜ === */
  .py-ide-container { display: flex; flex-wrap: wrap; margin: 2rem 0; background: #1e1e1e; border-radius: 6px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #333; overflow: hidden; font-family: -apple-system, sans-serif; }
  .py-main-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; border-right: 1px solid #333; }
  .py-sidebar-col { width: 260px; background: #252526; display: flex; flex-direction: column; font-size: 13px; border-left: 1px solid #333; }
  .py-header { background: #333333; padding: 0 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #252526; height: 38px; font-size: 12px; font-weight: 600; color: #bbb; }
  .py-header-title { display: flex; align-items: center; gap: 10px; }
  .py-shortcut-hint { font-size: 10px; color: #666; font-weight: normal; border: 1px solid #444; padding: 1px 4px; border-radius: 3px;}
  .py-btn-group { display: flex; gap: 6px; }
  /* ä¿®æ”¹ .py-editor æ ·å¼ */
  .py-editor { 
  min-height: 250px; 
  padding: 15px; 
  /* å­—ä½“è®¾ç½®å¾ˆé‡è¦ï¼Œå¿…é¡»ç­‰å®½ */
  font-family: 'Fira Code', 'Menlo', 'Consolas', monospace; 
  font-size: 14px !important; 
  line-height: 1.5 !important; 
  background-color: #1e1e1e; 
  color: #d4d4d4; 
  outline: none; 
  overflow: auto; 
  border-radius: 0 0 6px 6px;
  /* å…³é”®ï¼šè®¾ç½®å…‰æ ‡é¢œè‰²ï¼Œå¦åˆ™åœ¨æŸäº›æµè§ˆå™¨å¯èƒ½çœ‹ä¸è§ */
  caret-color: #fff; 
  /* ä¿æŒç©ºç™½ç¬¦æ ¼å¼ */
  white-space: pre !important;
}

/* è¦†ç›– Prism çš„é»˜è®¤èƒŒæ™¯ï¼Œä½¿å…¶é€æ˜ä»¥èåˆä½ çš„ IDE èƒŒæ™¯ */
pre[class*="language-"], code[class*="language-"] {
  text-shadow: none !important;
  background: transparent !important;
  margin: 0 !important;
  padding: 0 !important;
  border: none !important;
  box-shadow: none !important;
}
  .py-icon-btn { border: none; padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; transition: 0.2s; }
  .py-run-btn { background: #2e7d32; color: #fff; }
  .py-run-btn:hover { background: #388e3c; }
  .py-run-btn:disabled { background: #444; color: #888; cursor: wait; }
  .py-reset-btn { background: transparent; color: #aaa; border: 1px solid #444; }
  .py-reset-btn:hover { background: #444; color: #fff; }
  .py-output { background: #1e1e1e; color: #cccccc; padding: 10px; font-family: 'Fira Code', 'Menlo', monospace; font-size: 14px; white-space: pre-wrap; border-top: 1px solid #333; max-height: 200px; overflow-y: auto; border-left: 3px solid #007acc; }
  .py-plot-container { background: white; padding: 15px; text-align: center; border-top: 1px solid #333; display: none; }
  .py-tree-container { flex: 1; overflow-y: auto; padding: 8px; font-family: 'Fira Code', monospace; }
  .t-node { margin-left: 14px; line-height: 1.6; }
  .t-key { color: #9cdcfe; margin-right: 5px; cursor: pointer; }
  .t-key:hover { color: #4ec9b0; }
  .t-val { color: #ce9178; }
  .t-type { color: #569cd6; opacity: 0.7; font-size: 0.9em; margin-left: 6px; font-style: italic;}
  .t-arrow { display: inline-block; width: 10px; color: #888; cursor: pointer; transition: transform 0.1s; font-size: 10px; margin-left: -12px; margin-right: 2px;}
  .t-arrow.open { transform: rotate(90deg); }
  .t-collapsible { display: none; }
  .t-collapsible.open { display: block; }
  .t-empty { color: #666; font-style: italic; margin-left: 14px;}
</style>

{{ $rawContent := .Inner }}
{{ $cleanContent := $rawContent | replaceRE "^(?s)\\s*```[a-zA-Z0-9]*\\s+" "" }}
{{ $cleanContent := $cleanContent | replaceRE "\\s*```\\s*$" "" }}
{{ $b64Code := $cleanContent | base64Encode }}

<div class="py-ide-container">
    <div class="py-main-col">
        <div class="py-header">
            <div class="py-header-title">
                <span>TERMINAL</span>
                <span class="py-shortcut-hint">Ctrl + Enter to Run</span>
            </div>
            <div class="py-btn-group">
                <button id="reset-{{ .Ordinal }}" class="py-icon-btn py-reset-btn" py-click="reset_code_{{ .Ordinal }}">â†º RESET</button>
                <button id="btn-{{ .Ordinal }}" class="py-icon-btn py-run-btn" py-click="run_code_{{ .Ordinal }}">â–¶ RUN</button>
            </div>
        </div>
        
        <div id="editor-{{ .Ordinal }}" class="py-editor language-python" data-code="{{ $b64Code }}"></div>
        <div class="py-output" id="output-{{ .Ordinal }}">> Initializing Python...</div>
        
        <div id="plot-header-{{ .Ordinal }}" class="py-header" style="display: none; justify-content: flex-end; border-top: 1px solid #333;">
            <button id="copy-png-btn-{{ .Ordinal }}" class="py-icon-btn py-reset-btn">å¤åˆ¶ä¸º PNG</button>
        </div>
        <div class="py-plot-container" id="plot-{{ .Ordinal }}"></div>
    </div>

    <div class="py-sidebar-col">
        <div class="py-header">VARIABLES</div>
        <div id="tree-{{ .Ordinal }}" class="py-tree-container"></div>
    </div>
</div>

<script type="module">
    // åŠ¨æ€å¼•å…¥ CodeJar (ä» CDN åŠ è½½ ES Module)
    import { CodeJar } from 'https://cdn.jsdelivr.net/npm/codejar@3.7.0/codejar.min.js';

    document.addEventListener("DOMContentLoaded", () => {
        const editorEl = document.getElementById("editor-{{ .Ordinal }}");
        const copyBtn = document.getElementById("copy-png-btn-{{ .Ordinal }}");

        if (!editorEl) {
            console.error("Py-IDE Error: Editor element not found.");
            return;
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šå®šä¹‰é«˜äº®å‡½æ•° ---
        const highlight = (editor) => {
            // ä½¿ç”¨ Prism å¯¹ä»£ç è¿›è¡Œé«˜äº®å¤„ç†
            if (window.Prism) {
                // å°†ä»£ç æ–‡æœ¬è½¬æ¢ä¸ºé«˜äº®åçš„ HTML
                editor.innerHTML = Prism.highlight(
                    editor.textContent, 
                    Prism.languages.python, 
                    'python'
                );
            }
        };

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆå§‹åŒ– CodeJar ---
        // CodeJar ä¼šæ¥ç®¡ contentEditable çš„è¾“å…¥äº‹ä»¶å’Œå…‰æ ‡ç®¡ç†
        const jar = CodeJar(editorEl, highlight, {
            tab: '    ', //æŒ‰ä¸‹ Tab é”®æ’å…¥ 4 ä¸ªç©ºæ ¼
        });

        // --- è§£ç å¹¶å¡«å……åˆå§‹ä»£ç  ---
        try {
            const rawB64 = editorEl.getAttribute("data-code");
            const decodedCode = decodeURIComponent(escape(window.atob(rawB64)));
            
            // ä½¿ç”¨ CodeJar çš„ updateCode æ–¹æ³•æ¥è®¾ç½®å†…å®¹ï¼Œå®ƒä¼šè‡ªåŠ¨è§¦å‘é«˜äº®
            jar.updateCode(decodedCode);
            
            // ç¡®ä¿åœ¨ PyScript å‡†å¤‡å¥½ä¹‹å‰ä»£ç å·²ç»æ˜¾ç¤º
            // (CodeJar ä¼šè‡ªåŠ¨å¤„ç† contentEditable="true")
        } catch (e) {
            console.error("Py-IDE Error: Failed to decode code.", e);
            editorEl.textContent = "# Error: Could not load code.";
        }

        // --- ç»‘å®šå¿«æ·é”® (é€»è¾‘ä¿æŒä¸å˜) ---
        editorEl.addEventListener('keydown', (e) => {
            // é˜»æ­¢ Ctrl+S ä¿å­˜ç½‘é¡µ
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
            }
            // Ctrl + Enter è¿è¡Œ
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                const runBtn = document.getElementById("btn-{{ .Ordinal }}");
                if (runBtn && !runBtn.disabled) runBtn.click();
            }
        });

        // --- å˜é‡æ ‘å’Œæˆªå›¾åŠŸèƒ½ (ä¿æŒä¸å˜) ---
        window.renderJsonTree = (containerId, jsonString) => {
            // ... (æ­¤å¤„ä¿æŒä½ åŸæœ‰çš„ renderJsonTree ä»£ç ä¸å˜) ...
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            let data;
            try { data = JSON.parse(jsonString); } catch (e) { return; }
            const createNode = (key, value, type, children) => {
                const div = document.createElement("div");
                div.className = "t-node";
                if (children !== null) {
                    const arrow = document.createElement("span");
                    arrow.className = "t-arrow";
                    arrow.innerText = "â–¶";
                    const label = document.createElement("span");
                    label.innerHTML = `<span class="t-key">${key}:</span><span class="t-type">${type}</span>`;
                    const childContainer = document.createElement("div");
                    childContainer.className = "t-collapsible";
                    const toggle = (e) => {
                        e.stopPropagation();
                        childContainer.classList.toggle("open");
                        arrow.classList.toggle("open");
                        arrow.innerText = arrow.classList.contains("open") ? "â–¼" : "â–¶";
                    };
                    arrow.onclick = toggle;
                    label.onclick = toggle;
                    div.appendChild(arrow);
                    div.appendChild(label);
                    div.appendChild(childContainer);
                    if (Object.keys(children).length === 0) {
                        childContainer.innerHTML = '<div class="t-empty">(empty)</div>';
                    } else {
                        for (const [k, v] of Object.entries(children)) {
                            childContainer.appendChild(createNode(k, v.val, v.type, v.children));
                        }
                    }
                } else {
                    div.innerHTML = `<span class="t-key" style="cursor:default">${key}:</span><span class="t-val">${value}</span>`;
                }
                return div;
            };
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div class="t-empty" style="margin-top:10px">No user variables</div>';
            } else {
                for (const [k, v] of Object.entries(data)) {
                    container.appendChild(createNode(k, v.val, v.type, v.children));
                }
            }
        };

        const copyPlotAsPng = (btn) => {
             // ... (æ­¤å¤„ä¿æŒä½ åŸæœ‰çš„ copyPlotAsPng ä»£ç ä¸å˜) ...
             const plotContainer = document.getElementById("plot-{{ .Ordinal }}");
             // ...ç•¥...
             // è¿™é‡Œçš„ä»£ç å¤ªé•¿ï¼Œé€»è¾‘ä¸ç”¨åŠ¨ï¼Œç›´æ¥å¤åˆ¶ä½ åŸæ¥çš„å³å¯
             const svgElement = plotContainer ? plotContainer.querySelector('svg') : null;
             if (!svgElement) { alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°éœ€è¦å¤åˆ¶çš„å›¾åƒã€‚"); return; }
             const canvas = document.createElement('canvas');
             const ctx = canvas.getContext('2d');
             const scale = 2; 
             const viewbox = svgElement.viewBox.baseVal;
             canvas.width = viewbox.width * scale;
             canvas.height = viewbox.height * scale;
             const img = new Image();
             const svgData = new XMLSerializer().serializeToString(svgElement);
             const svgUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
             img.onload = () => {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                        .then(() => {
                            const originalText = btn.innerText;
                            btn.innerText = "å·²å¤åˆ¶!";
                            setTimeout(() => { btn.innerText = originalText; }, 2000);
                        })
                        .catch(err => { console.error('å¤åˆ¶å¤±è´¥', err); alert('å¤åˆ¶å¤±è´¥'); });
                }, 'image/png');
             };
             img.src = svgUrl;
        };

        if (copyBtn) copyBtn.onclick = (e) => copyPlotAsPng(e.target);
    });
</script>
<!-- Python ä»£ç éƒ¨åˆ†ä¿æŒä¸å˜ -->
<script type="py" config='{"packages": ["micropip"]}'>
    from pyscript import window, document, HTML
    import sys, io, micropip, asyncio, html, types, json, base64, os

    class DOMStream:
        def __init__(self, element_id): self.element_id = element_id
        def write(self, text):
            el = document.getElementById(self.element_id)
            if el:
                el.innerText += text
                el.scrollTop = el.scrollHeight
        def flush(self): pass

    if 'kernels' not in globals(): kernels = {}
    if {{ .Ordinal }} not in kernels: kernels[{{ .Ordinal }}] = {}

    async def init_system_{{ .Ordinal }}():
        output_id = "output-{{ .Ordinal }}"
        stream = DOMStream(output_id)
        stream.write("> Core loaded.\n")
        stream.write("> Downloading libraries & resources...\n")
        
        try:
            await micropip.install(["numpy", "matplotlib"])
            import matplotlib
            matplotlib.use("Agg") 
            import matplotlib.pyplot as plt
            import matplotlib.font_manager as fm
            from pyodide.http import pyfetch

            font_url = "{{ "font/LXGWWenKaiLite-Light.ttf" | relURL }}" 
            font_path = "LXGWWenKaiLite-Light.ttf" 
            stream.write(f"> Fetching font from: {font_url}\n")
            
            response = await pyfetch(font_url)
            if response.status == 200:
                with open(font_path, "wb") as f:
                    f.write(await response.bytes())
                fm.fontManager.addfont(font_path)
                plt.rcParams['font.family'] = ['LXGW WenKai Lite'] 
                plt.rcParams['axes.unicode_minus'] = False 
                stream.write("> Chinese font configured.\n")
            else:
                stream.write(f"> Warning: Failed to fetch font (Status {response.status}).\n")
            stream.write("> System Ready. ğŸš€\n")
        except Exception as e:
            stream.write(f"> Init Error: {e}\n")

    asyncio.ensure_future(init_system_{{ .Ordinal }}())

    def get_scope_tree(scope):
        tree_data = {}
        def safe_str(v):
            try: s = str(v)
            except: s = "<error>"
            return html.escape(s[:50] + "..." if len(s) > 50 else s)
        for k, v in scope.items():
            if k.startswith("_") or k in ['open', 'exit', 'quit', 'In', 'Out', 'get_ipython', 'show_plot', 'matplotlib', 'plt', 'micropip', 'fm', 'pyfetch', 'os']: continue
            if isinstance(v, (types.ModuleType, types.FunctionType, type)): continue
            val_type = type(v).__name__
            children = None
            display_val = safe_str(v)
            if isinstance(v, dict):
                children = {}
                display_val = f"dict[{len(v)}]"
                for sk, sv in list(v.items())[:20]:
                    children[str(sk)] = {"val": safe_str(sv), "type": type(sv).__name__, "children": None}
            elif isinstance(v, (list, tuple)):
                children = {}
                display_val = f"{val_type}[{len(v)}]"
                for i, sv in enumerate(v[:20]):
                    children[str(i)] = {"val": safe_str(sv), "type": type(sv).__name__, "children": None}
            tree_data[k] = {"val": display_val, "type": val_type, "children": children}
        return json.dumps(tree_data)

    def _show_plot_helper():
        try:
            import matplotlib.pyplot as plt
        except ImportError:
            print("Matplotlib not ready yet.")
            return
        plot_div = document.getElementById("plot-{{ .Ordinal }}")
        plot_header = document.getElementById("plot-header-{{ .Ordinal }}")
        buf = io.StringIO()
        try:
            plt.savefig(buf, format='svg', bbox_inches='tight')
            buf.seek(0)
            svg_string = buf.getvalue()
            plot_div.innerHTML = svg_string
            plot_div.style.display = "block"
            plot_header.style.display = "flex"
            print("System: SVG Plot generated.")
        except Exception as e:
            print(f"System Error: Plotting failed - {e}")
        finally:
            plt.clf()
            buf.close()

    def reset_code_{{ .Ordinal }}(event):
        kernels[{{ .Ordinal }}] = {}
        kernels[{{ .Ordinal }}]["show_plot"] = _show_plot_helper
        document.getElementById("output-{{ .Ordinal }}").innerText = "> Environment reset."
        window.renderJsonTree("tree-{{ .Ordinal }}", "{}")
        document.getElementById("plot-{{ .Ordinal }}").style.display = "none"
        document.getElementById("plot-header-{{ .Ordinal }}").style.display = "none"

    async def run_code_{{ .Ordinal }}(event):
        output_id = "output-{{ .Ordinal }}"
        tree_id = "tree-{{ .Ordinal }}"
        btn = document.getElementById("btn-{{ .Ordinal }}")
        output_el = document.getElementById(output_id)
        btn.disabled = True
        btn.innerText = "Running..."
        output_el.innerText = "" 
        user_selection = window.getSelection().toString()
        full_code = document.getElementById("editor-{{ .Ordinal }}").textContent
        code_to_run = user_selection if user_selection.strip() else full_code
        if user_selection.strip(): output_el.innerText = "> Running selection...\n"
        current_scope = kernels[{{ .Ordinal }}]
        if "show_plot" not in current_scope: current_scope["show_plot"] = _show_plot_helper
        first_line = code_to_run.strip().split('\n')[0]
        if first_line.startswith("# install:"):
            pkgs = [p.strip() for p in first_line.replace("# install:", "").split(",") if p.strip()]
            if pkgs:
                output_el.innerText += f"> Installing: {', '.join(pkgs)}...\n"
                try: await micropip.install(pkgs)
                except Exception as e: output_el.innerText += f"Install failed: {e}\n"
        stream = DOMStream(output_id)
        original_stdout, original_stderr = sys.stdout, sys.stderr
        sys.stdout, sys.stderr = stream, stream
        try:
            exec(code_to_run, current_scope, current_scope)
        except Exception as e:
            print(f"Runtime Error: {e}")
        finally:
            sys.stdout, sys.stderr = original_stdout, original_stderr
            try:
                tree_json = get_scope_tree(current_scope)
                window.renderJsonTree(tree_id, tree_json)
            except Exception as e: print(f"Tree Error: {e}")
            btn.disabled = False
            btn.innerText = "â–¶ RUN"
</script>