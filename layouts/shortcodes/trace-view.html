{{ $tracePath := .Get 0 }}
{{ $userHeight := .Get 1 | default "auto" }}

<div id="trace-wrapper-{{ .Ordinal }}" class="stanford-trace-wrapper" style="
    position: relative; margin: 2rem 0; width: 100%; border-radius: 8px; overflow: hidden;
    background: transparent; border: 1px solid var(--ide-border, #d0d7de);
    /* 初始高度 */
    min-height: 150px;
    transition: border-color 0.3s;
">
    <!-- 按钮组 -->
    <div style="position: absolute; top: 9px; right: 12px; z-index: 50; display: flex; gap: 8px;">
        <button id="trace-fs-{{ .Ordinal }}" onclick="toggleFullscreen('{{ .Ordinal }}')" style="
            background: transparent; border: 1px solid rgba(127,127,127,0.2); color: inherit;
            padding: 3px 8px; border-radius: 4px; cursor: pointer; 
            font-family: -apple-system, sans-serif; font-size: 14px; line-height: 1;
            backdrop-filter: blur(2px); transition: all 0.2s; opacity: 0.6;
        " title="Toggle Fullscreen">⛶</button>

        <button id="trace-copy-{{ .Ordinal }}" onclick="copyTrace('{{ .Ordinal }}')" style="
            background: transparent; border: 1px solid rgba(127,127,127,0.2); color: inherit;
            padding: 3px 8px; border-radius: 4px; cursor: pointer; 
            font-family: -apple-system, sans-serif; font-size: 11px; font-weight: 600;
            backdrop-filter: blur(2px); transition: all 0.2s; opacity: 0.6;
        ">Copy</button>
    </div>

    <iframe 
        id="trace-iframe-{{ .Ordinal }}"
        src='{{ "cs336-viewer/" | relURL }}?trace={{ $tracePath | relURL }}' 
        width="100%" height="200px" scrolling="no" frameborder="0"
        style="display: block; width: 100%; border: none;" allowfullscreen>
    </iframe>
</div>

<style>
    .stanford-trace-wrapper:fullscreen { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: var(--bg-color, #fff); }
    .stanford-trace-wrapper:fullscreen iframe { height: 95vh !important; width: 100% !important; max-width: 1600px; }
    .stanford-trace-wrapper:-webkit-full-screen { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
    .stanford-trace-wrapper:-webkit-full-screen iframe { height: 95vh !important; width: 100% !important; }
</style>

<script>
window.toggleFullscreen = function(id) {
    const wrapper = document.getElementById('trace-wrapper-' + id);
    const btn = document.getElementById('trace-fs-' + id);
    if (!document.fullscreenElement) {
        if(wrapper.requestFullscreen) wrapper.requestFullscreen();
        else if(wrapper.webkitRequestFullscreen) wrapper.webkitRequestFullscreen();
        btn.innerHTML = "✖"; btn.style.borderColor = "#2da44e"; btn.style.color = "#2da44e"; btn.style.opacity = "1";
    } else {
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        btn.innerHTML = "⛶"; btn.style.borderColor = "rgba(127,127,127,0.2)"; btn.style.color = "inherit"; btn.style.opacity = "0.6";
    }
};

window.copyTrace = function(id) {
    const iframe = document.getElementById('trace-iframe-' + id);
    if(!iframe || !iframe.contentDocument) return;
    const doc = iframe.contentDocument;
    
    // 优先尝试基于 DOM 结构的复制
    const lineElements = doc.querySelectorAll('.line');
    if (lineElements.length > 0) {
        const codeLines = Array.from(lineElements).map(lineEl => {
            if (lineEl.children.length >= 2) return lineEl.lastElementChild.innerText;
            return lineEl.innerText.replace(/^\s*\d+/, ''); 
        });
        copyToClip(codeLines.join('\n'), id);
    } else {
        // 兜底正则复制
        const raw = doc.body.innerText;
        copyToClip(raw, id);
    }
};

function copyToClip(text, id) {
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('trace-copy-' + id);
        const originalText = btn.innerText;
        btn.innerText = "✓"; btn.style.color = "#2da44e"; btn.style.borderColor = "#2da44e"; btn.style.opacity = "1";
        setTimeout(() => { btn.innerText = originalText; btn.style.color = "inherit"; btn.style.borderColor = "rgba(127,127,127,0.2)"; btn.style.opacity = "0.6"; }, 2000);
    });
}

(function() {
    const iframe = document.getElementById("trace-iframe-{{ .Ordinal }}");
    const wrapper = iframe.parentElement;
    const isAutoHeight = "{{ $userHeight }}" === "auto";
    let resizeObserver = null;

    function updateTheme() {
        if (!iframe.contentDocument) return;
        const doc = iframe.contentDocument;
        const html = document.documentElement;
        
        const isDark = html.classList.contains('dark') || html.getAttribute('data-theme') === 'dark';
        if (isDark) doc.documentElement.classList.add('dark');
        else doc.documentElement.classList.remove('dark');

        // --- 1. 获取父页面的全局字体变量 ---
        const globalFont = getComputedStyle(document.documentElement).getPropertyValue('--global-code-font') || "monospace";

        // === 注入 CSS：强制切断高度继承 ===
        let st = doc.getElementById('hugo-inj-layout');
        if(!st) { st = doc.createElement('style'); st.id='hugo-inj-layout'; doc.head.appendChild(st); }
        st.innerHTML = `
            /* 强制 html/body 只有自动高度，不许继承 iframe 高度 */
            html, body {
                height: auto !important;
                min-height: 0 !important;
                overflow: hidden !important; /* 让 iframe 外部不可滚动，完全依赖 iframe 高度 */
                margin: 0 !important;
                padding: 0 !important;
            }
            #root {
                height: auto !important;
                min-height: 0 !important;
                display: block !important; /* 确保它是块级，撑开内容 */
            }
            /* 确保内容容器不被拉伸 */
            .trace-viewer-container {
                height: auto !important;
                min-height: 0 !important;
            }
            /* --- 仅新增：强制所有元素使用父页面的字体 --- */
            * {
                font-family: ${globalFont} !important;
            }
        `;
    }

    function initAutoResize() {
        if (!isAutoHeight || !iframe.contentDocument) return;
        
        const doc = iframe.contentDocument;
        
        // === 关键修改：不要监听 body，监听实际的内容容器 ===
        // .trace-viewer-container 是 React 中包裹所有内容的 div
        const target = doc.querySelector('.trace-viewer-container') || doc.getElementById('root') || doc.body;
        
        if (resizeObserver) resizeObserver.disconnect();
        
        resizeObserver = new ResizeObserver(entries => {
            if (document.fullscreenElement) return;

            for (let entry of entries) {
                // 获取内容容器的真实高度
                // scrollHeight 在某些 flex 布局下可能不准确，优先用 getBoundingClientRect
                const rect = entry.target.getBoundingClientRect();
                let newHeight = rect.height;
                
                // 如果检测到高度异常小(还没加载)，回退到 scrollHeight
                if (newHeight < 50) newHeight = entry.target.scrollHeight;

                // 加上头部/底部的余量 (padding)
                newHeight += 20;

                // 只有当高度变大，或者显著变小时才调整 (防止微小抖动)
                if (Math.abs(iframe.clientHeight - newHeight) > 5) {
                    iframe.style.height = newHeight + "px";
                }
            }
        });
        
        resizeObserver.observe(target);
    }

    iframe.onload = () => {
        updateTheme();
        // 延时启动，等待 React 首次渲染完毕
        setTimeout(initAutoResize, 200);
    };
    
    new MutationObserver(updateTheme).observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'data-theme'] });
    
    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('trace-fs-{{ .Ordinal }}');
        if (!document.fullscreenElement) {
            btn.innerHTML = "⛶"; btn.style.borderColor = "rgba(127,127,127,0.2)"; btn.style.color = "inherit"; btn.style.opacity = "0.6";
            setTimeout(initAutoResize, 200);
        }
    });
})();
</script>