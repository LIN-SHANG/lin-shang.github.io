{{ $tracePath := .Get 0 }}
{{ $userHeight := .Get 1 | default "auto" }}

<div id="trace-wrapper-{{ .Ordinal }}" class="stanford-trace-wrapper" style="
    position: relative;
    margin: 2rem 0;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    background: transparent; /* JS 会填充具体颜色 */
    transition: all 0.3s ease;
    border: 1px solid transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
">
    <!-- 按钮组容器 -->
    <div style="position: absolute; top: 9px; right: 12px; z-index: 50; display: flex; gap: 8px;">
        
        <!-- 全屏按钮 (新增) -->
        <button id="trace-fs-{{ .Ordinal }}" onclick="toggleFullscreen('{{ .Ordinal }}')" style="
            background: transparent; 
            border: 1px solid rgba(127,127,127,0.2);
            color: inherit;
            padding: 3px 8px; border-radius: 4px; cursor: pointer; 
            font-family: -apple-system, sans-serif; font-size: 14px; line-height: 1;
            backdrop-filter: blur(2px); transition: all 0.2s; opacity: 0.6;
        " title="Toggle Fullscreen">⛶</button>

        <!-- Copy 按钮 -->
        <button id="trace-copy-{{ .Ordinal }}" onclick="copyTrace('{{ .Ordinal }}')" style="
            background: transparent; 
            border: 1px solid rgba(127,127,127,0.2);
            color: inherit;
            padding: 3px 8px; border-radius: 4px; cursor: pointer; 
            font-family: -apple-system, sans-serif; font-size: 11px; font-weight: 600;
            backdrop-filter: blur(2px); transition: all 0.2s; opacity: 0.6;
        ">Copy</button>
    </div>

    <iframe 
        id="trace-iframe-{{ .Ordinal }}"
        src='{{ "cs336-viewer/" | relURL }}?trace={{ $tracePath | relURL }}' 
        width="100%" 
        height="200px" 
        scrolling="no"
        frameborder="0"
        style="display: block; width: 100%; border: none;"
        allowfullscreen>
    </iframe>
</div>

<!-- 
    全屏样式补丁 
    注意：:fullscreen 伪类用于控制全屏时的样式
-->
<style>
    /* 当 Wrapper 进入全屏时 */
    .stanford-trace-wrapper:fullscreen {
        padding: 20px; /* 给点呼吸空间 */
        overflow-y: auto; /* 允许垂直滚动 */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
    }
    
    /* 全屏时强制 iframe 高度撑满，忽略 JS 计算的高度 */
    .stanford-trace-wrapper:fullscreen iframe {
        height: 95vh !important; /* 占据绝大部分屏幕高度 */
        width: 100% !important;
        max-width: 1600px; /* 防止在超宽屏上太宽 */
    }

    /* 针对 Safari 的前缀支持 */
    .stanford-trace-wrapper:-webkit-full-screen { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
    .stanford-trace-wrapper:-webkit-full-screen iframe { height: 95vh !important; width: 100% !important; }
</style>

<script>
// === 全屏切换逻辑 ===
window.toggleFullscreen = function(id) {
    const wrapper = document.getElementById('trace-wrapper-' + id);
    const btn = document.getElementById('trace-fs-' + id);
    
    if (!document.fullscreenElement) {
        // 进入全屏
        if(wrapper.requestFullscreen) wrapper.requestFullscreen();
        else if(wrapper.webkitRequestFullscreen) wrapper.webkitRequestFullscreen(); // Safari
        
        btn.innerHTML = "✖"; // 变成关闭图标
        btn.style.borderColor = "#2da44e";
        btn.style.color = "#2da44e";
        btn.style.opacity = "1";
    } else {
        // 退出全屏
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        
        btn.innerHTML = "⛶"; // 变回全屏图标
        btn.style.borderColor = "rgba(127,127,127,0.2)";
        btn.style.color = "inherit";
        btn.style.opacity = "0.6";
    }
};

// === 复制逻辑 (保持不变) ===
window.copyTrace = function(id) {
    const iframe = document.getElementById('trace-iframe-' + id);
    if(!iframe || !iframe.contentDocument) return;
    const doc = iframe.contentDocument;
    const lineElements = doc.querySelectorAll('.line');
    
    if (lineElements.length > 0) {
        const codeLines = Array.from(lineElements).map(lineEl => {
            if (lineEl.children.length >= 2) return lineEl.lastElementChild.innerText;
            return lineEl.innerText.replace(/^\s*\d+/, ''); 
        });
        navigator.clipboard.writeText(codeLines.join('\n')).then(() => {
            const btn = document.getElementById('trace-copy-' + id);
            const originalText = btn.innerText;
            btn.innerText = "✓";
            btn.style.color = "#2da44e";
            btn.style.borderColor = "#2da44e";
            btn.style.opacity = "1";
            setTimeout(() => { 
                btn.innerText = originalText; 
                btn.style.color = "inherit"; 
                btn.style.borderColor = "rgba(127,127,127,0.2)"; 
                btn.style.opacity = "0.6";
            }, 2000);
        });
    }
};

(function() {
    const iframe = document.getElementById("trace-iframe-{{ .Ordinal }}");
    const wrapper = iframe.parentElement;
    const isAutoHeight = "{{ $userHeight }}" === "auto";
    let resizeObserver = null;

    function updateTheme() {
        if (!iframe.contentDocument) return;
        
        const computedStyle = getComputedStyle(document.documentElement);
        const globalFont = computedStyle.getPropertyValue('--global-code-font').trim();
        const globalSize = computedStyle.getPropertyValue('--global-code-size').trim();
        const globalLineHeight = computedStyle.getPropertyValue('--global-line-height').trim();

        const isDark = document.documentElement.classList.contains('dark') || 
                       document.body.classList.contains('dark') ||
                       document.documentElement.getAttribute('data-theme') === 'dark';

        const theme = isDark ? {
            bg: '#161b22', fg: '#c9d1d9', border: '#30363d',
            header_bg: '#0d1117',
            hl_bg: 'rgba(187, 128, 9, 0.15)',
            hl_border: '#d29922'
        } : {
            bg: '#f6f8fa', fg: '#24292e', border: '#d0d7de',
            header_bg: '#ffffff',
            hl_bg: '#fffbdd',
            hl_border: '#d4a72c'
        };

        // 这里的背景色设置非常关键，全屏时浏览器背景默认是黑/白的
        // 设置到 wrapper 上可以保证全屏时背景色与主题一致
        wrapper.style.backgroundColor = theme.bg;
        wrapper.style.borderColor = theme.border;
        
        const copyBtn = document.getElementById('trace-copy-{{ .Ordinal }}');
        const fsBtn = document.getElementById('trace-fs-{{ .Ordinal }}');
        if(copyBtn) copyBtn.style.color = theme.fg;
        if(fsBtn) fsBtn.style.color = theme.fg;

        const doc = iframe.contentDocument;
        let st = doc.getElementById('hugo-inj');
        if(!st) { st = doc.createElement('style'); st.id='hugo-inj'; doc.head.appendChild(st); }

        st.innerHTML = `
            html, body {
                height: auto !important; min-height: 0 !important;
                margin: 0 !important; padding: 0 !important;
                background-color: ${theme.bg} !important;
                color: ${theme.fg} !important;
                font-family: ${globalFont} !important; 
                font-size: ${globalSize} !important;
                line-height: ${globalLineHeight} !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
            }
            #root, .trace-viewer-container {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                justify-content: flex-start !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            .lines-panel {
                width: 100% !important;
                overflow-x: auto !important;
                padding-bottom: 10px !important;
            }
            .header {
                background-color: ${theme.header_bg} !important;
                border-bottom: 1px solid ${theme.border} !important;
                padding: 6px 12px !important;
                display: flex; align-items: center;
                width: 100% !important; box-sizing: border-box !important;
                font-family: -apple-system, sans-serif !important;
                font-size: 12px !important;
            }
            .header-title { opacity: 0.8; font-weight: 500; }
            .icon-buttons { opacity: 0.6; transform: scale(0.9); }
            .lines-content { padding: 8px 0 !important; }
            [class*="bg-yellow-"] {
                background-color: ${theme.hl_bg} !important;
                border-left: 2px solid ${theme.hl_border} !important;
                box-shadow: none !important;
            }
            pre, code, span { 
                font-family: ${globalFont} !important; 
                font-size: ${globalSize} !important;
            }
        `;
        
        if(isDark) doc.documentElement.classList.add('dark');
        else doc.documentElement.classList.remove('dark');
    }

    function initAutoResize() {
        if (!isAutoHeight || !iframe.contentDocument) return;
        const target = iframe.contentDocument.getElementById('root') || iframe.contentDocument.body;
        if (resizeObserver) resizeObserver.disconnect();
        resizeObserver = new ResizeObserver(entries => {
            // 如果处于全屏模式，不要执行自动高度调整，以免打架
            if (document.fullscreenElement) return;

            for (let entry of entries) {
                const newHeight = entry.target.scrollHeight;
                if (Math.abs(iframe.clientHeight - newHeight) > 3) {
                    iframe.style.height = (newHeight + 12) + "px";
                }
            }
        });
        resizeObserver.observe(target);
    }

    iframe.onload = () => {
        updateTheme();
        setTimeout(initAutoResize, 200);
    };
    const obs = new MutationObserver(updateTheme);
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'data-theme'] });
    
    // 监听全屏变化，处理退出全屏时的图标复位
    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('trace-fs-{{ .Ordinal }}');
        if (!document.fullscreenElement) {
            btn.innerHTML = "⛶";
            btn.style.borderColor = "rgba(127,127,127,0.2)";
            btn.style.color = "inherit";
            btn.style.opacity = "0.6";
            // 退出全屏后立即重新计算一次高度
            setTimeout(initAutoResize, 100);
        }
    });
})();
</script>