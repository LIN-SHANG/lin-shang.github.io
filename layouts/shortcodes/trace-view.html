{{ $tracePath := .Get 0 }}
{{ $userHeight := .Get 1 | default "auto" }}

<!-- Trace View Wrapper -->
<div class="stanford-trace-wrapper" style="
    position: relative;
    margin: 2rem 0;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    background: transparent;
    transition: all 0.3s ease;
    border: 1px solid transparent; /* 边框由 JS 控制颜色 */
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
">
    <!-- 美化后的 Copy 按钮 (悬浮) -->
    <button id="trace-copy-{{ .Ordinal }}" onclick="copyTrace('{{ .Ordinal }}')" style="
        position: absolute; top: 9px; right: 12px; z-index: 50;
        background: transparent; 
        border: 1px solid rgba(127,127,127,0.2);
        color: inherit;
        padding: 3px 8px; border-radius: 4px; cursor: pointer; 
        font-family: -apple-system, sans-serif; font-size: 11px; font-weight: 600;
        backdrop-filter: blur(2px);
        transition: all 0.2s;
        opacity: 0.6;
    ">Copy</button>

    <iframe 
        id="trace-iframe-{{ .Ordinal }}"
        src="/cs336-viewer/index.html?trace={{ $tracePath | relURL }}" 
        width="100%" 
        height="200px" 
        scrolling="no"
        frameborder="0"
        style="display: block; width: 100%; border: none;"
        allowfullscreen>
    </iframe>
</div>

<script>
// 1. 复制功能
window.copyTrace = function(id) {
    const iframe = document.getElementById('trace-iframe-' + id);
    if(iframe && iframe.contentDocument) {
        const body = iframe.contentDocument.body;
        // 尝试找到代码主体
        const codeBlock = body.querySelector('code') || body.querySelector('pre') || body;
        navigator.clipboard.writeText(codeBlock.innerText).then(() => {
            const btn = document.getElementById('trace-copy-' + id);
            const originalText = btn.innerText;
            btn.innerText = "✓";
            btn.style.color = "#2da44e";
            btn.style.borderColor = "#2da44e";
            btn.style.opacity = "1";
            setTimeout(() => { 
                btn.innerText = originalText; 
                btn.style.color = "inherit"; 
                btn.style.borderColor = "rgba(127,127,127,0.2)";
                btn.style.opacity = "0.6";
            }, 2000);
        });
    }
};

(function() {
    const iframe = document.getElementById("trace-iframe-{{ .Ordinal }}");
    const wrapper = iframe.parentElement;
    const isAutoHeight = "{{ $userHeight }}" === "auto";
    let resizeObserver = null;

    // 2. 主题更新逻辑 (核心美化)
    function updateTheme() {
        if (!iframe.contentDocument) return;
        
        // 读取全局字体设置
        const computedStyle = getComputedStyle(document.documentElement);
        const globalFont = computedStyle.getPropertyValue('--global-code-font').trim();
        const globalSize = computedStyle.getPropertyValue('--global-code-size').trim();
        const globalLineHeight = computedStyle.getPropertyValue('--global-line-height').trim();

        // 读取主题颜色 (从 custom_style.html 定义的变量获取)
        // 为了确保颜色准确，我们手动判断 dark class，因为 iframe 无法直接继承父级变量
        const isDark = document.documentElement.classList.contains('dark') || 
                       document.body.classList.contains('dark') ||
                       document.documentElement.getAttribute('data-theme') === 'dark';

        // 配色方案 (必须与 custom_style.html 对应)
        const theme = isDark ? {
            bg: '#161b22', fg: '#c9d1d9', border: '#30363d',
            header_bg: '#0d1117',
            hl_bg: 'rgba(187, 128, 9, 0.15)', // 柔和高亮
            hl_border: '#d29922'
        } : {
            bg: '#f6f8fa', fg: '#24292e', border: '#d0d7de',
            header_bg: '#ffffff',
            hl_bg: '#fffbdd', // 柔和高亮
            hl_border: '#d4a72c'
        };

        // 应用到外部容器
        wrapper.style.backgroundColor = theme.bg;
        wrapper.style.borderColor = theme.border;
        const btn = document.getElementById('trace-copy-{{ .Ordinal }}');
        if(btn) btn.style.color = theme.fg;

        // 注入内部样式
        const doc = iframe.contentDocument;
        let st = doc.getElementById('hugo-inj');
        if(!st) { st = doc.createElement('style'); st.id='hugo-inj'; doc.head.appendChild(st); }

        st.innerHTML = `
            /* 全局 Reset */
            html, body, #root {
                height: auto !important; min-height: 0 !important;
                margin: 0 !important; padding: 0 !important;
                background-color: ${theme.bg} !important;
                color: ${theme.fg} !important;
                font-family: ${globalFont} !important; 
                font-size: ${globalSize} !important;
                line-height: ${globalLineHeight} !important;
                overflow-y: hidden !important;
            }

            /* 头部样式：扁平化，去除老旧风格 */
            .header {
                background-color: ${theme.header_bg} !important;
                border-bottom: 1px solid ${theme.border} !important;
                padding: 6px 12px !important;
                display: flex; align-items: center;
                font-family: -apple-system, sans-serif !important;
                font-size: 12px !important;
            }
            .header-title { opacity: 0.8; font-weight: 500; }
            .icon-buttons { opacity: 0.6; transform: scale(0.9); }

            /* 代码区域 */
            .lines-content { padding: 8px 0 !important; }
            
            /* 高亮行美化：去除实心，改用柔和背景 */
            [class*="bg-yellow-"] {
                background-color: ${theme.hl_bg} !important;
                border-left: 2px solid ${theme.hl_border} !important;
                box-shadow: none !important;
            }

            /* 强制统一代码字体 */
            pre, code, span { 
                font-family: ${globalFont} !important; 
                font-size: ${globalSize} !important;
            }
        `;
        
        if(isDark) doc.documentElement.classList.add('dark');
        else doc.documentElement.classList.remove('dark');
    }

    // 3. 高度自适应 (ResizeObserver)
    function initAutoResize() {
        if (!isAutoHeight || !iframe.contentDocument) return;
        const target = iframe.contentDocument.getElementById('root') || iframe.contentDocument.body;
        
        if (resizeObserver) resizeObserver.disconnect();
        
        resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                // 使用 scrollHeight 获取真实高度
                const newHeight = entry.target.scrollHeight;
                if (Math.abs(iframe.clientHeight - newHeight) > 3) {
                    iframe.style.height = newHeight + "px";
                }
            }
        });
        resizeObserver.observe(target);
    }

    // 初始化
    iframe.onload = () => {
        updateTheme();
        setTimeout(initAutoResize, 100);
    };

    // 监听主题切换
    const obs = new MutationObserver(updateTheme);
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'data-theme'] });
})();
</script>